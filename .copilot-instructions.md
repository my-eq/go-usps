# USPS Addresses API Go Client - Copilot Instructions

## Project Overview
This is a lightweight, production-grade Go client library for the USPS Addresses 3.0 REST API. The library is designed to be used by millions of people as a critical part of their workflows.

## Core Principles
1. **Lightweight & Clear**: Minimize dependencies and keep the code clear and concise
2. **Strongly Typed**: All data structures are strongly typed based on the OpenAPI specification
3. **Testability**: Code is structured with dependency injection for easy testing
4. **DRY**: Don't Repeat Yourself - common patterns are abstracted
5. **Professional Quality**: Follow Go best practices and idiomatic patterns

## Architecture

### Package Structure
- Root package (`github.com/my-eq/go-usps`) - Main package containing the client and API methods
- `models/` - Strongly-typed data models for requests and responses

### Key Components

#### Client (`client.go`)
- Main entry point for API interactions
- Handles base URL configuration (production vs testing)
- Manages HTTP client with proper timeouts
- Delegates authentication to auth provider
- Three main methods:
  - `GetAddress()` - Address standardization
  - `GetCityState()` - City/State lookup by ZIP
  - `GetZIPCode()` - ZIP code lookup by address

#### Token Provider
- `TokenProvider` interface for flexible authentication
- `StaticTokenProvider` implementation for simple use cases
- OAuth Bearer token support via Authorization header

#### Models (`models/`)
- Strongly typed structs matching OpenAPI schemas
- JSON tags for proper serialization
- Request types: `AddressRequest`, `CityStateRequest`, `ZIPCodeRequest`
- Response types: `AddressResponse`, `CityStateResponse`, `ZIPCodeResponse`
- Error types: `ErrorMessage`, `ErrorInfo`, `ErrorDetail`

### Error Handling
- Custom `APIError` type for API errors
- Structured error responses matching USPS API format
- HTTP status code handling (400, 401, 403, 404, 429, 503)
- Graceful handling of malformed error responses

### Testing Strategy
- Unit tests for all public methods (88.7% coverage)
- Mock HTTP responses using httptest
- Table-driven tests for edge cases
- Integration test examples (require real token)
- Example tests for godoc

## Implementation Status

### âœ… Completed Features
- [x] Go module initialization
- [x] All three API endpoints implemented
- [x] OAuth authentication support
- [x] Production and testing environment support
- [x] Strongly-typed models for all request/response types
- [x] Comprehensive error handling
- [x] Full test coverage (88.7%)
- [x] Integration test examples
- [x] Package documentation
- [x] README with usage examples
- [x] Example tests for godoc
- [x] MIT License
- [x] .gitignore configuration

### API Endpoints
1. **GET /address** - Address standardization
   - Validates and standardizes addresses
   - Returns ZIP+4 when available
   - Supports optional firm name, secondary address, urbanization
   
2. **GET /city-state** - City/State lookup
   - Returns city and state for a given ZIP code
   - Simple single-parameter request
   
3. **GET /zipcode** - ZIP code lookup
   - Returns ZIP code and ZIP+4 for an address
   - Requires street address, city, and state

## Coding Standards

### Naming Conventions
- Use Go conventions: `GetAddress`, not `get_address`
- Acronyms in caps when appropriate: `HTTPClient`, `USPSClient`, `ZIPCode`
- Clear, descriptive names over brevity

### Documentation
- All exported types, functions, and methods have godoc comments
- Comments start with the name of the thing being documented
- Package-level documentation in doc.go files
- Example tests demonstrate usage

### Dependencies
- **Zero external dependencies** - only Go standard library
- No third-party packages required
- Clean go.mod file

## Implementation Notes

### OAuth Authentication
- Token is passed via Authorization header: `Bearer {token}`
- Client accepts `TokenProvider` interface for flexibility
- `StaticTokenProvider` included for simple use cases
- Token refresh is caller's responsibility

### HTTP Client
- 30-second default timeout
- Full context support for cancellation
- Configurable via `WithTimeout()` and `WithHTTPClient()` options
- Uses standard library's net/http

### Query Parameters
- Custom `structToURLValues()` function for encoding
- Supports `url` struct tags with `omitempty` option
- Validates required parameters before making requests
- Handles optional parameters gracefully

### Response Handling
- Unmarshals JSON responses to strongly-typed structs
- Handles error responses with proper structure
- Graceful degradation for malformed error responses
- Preserves all response fields including optional ones

## Testing

### Running Tests
```bash
go test ./...                    # Run all tests
go test -v ./...                 # Verbose output
go test -cover ./...             # With coverage
go test -coverprofile=c.out ./...  # Generate coverage profile
```

### Test Coverage
- Current: 88.7% statement coverage
- 20+ test cases covering:
  - Success scenarios for all endpoints
  - Error scenarios (400, 404, etc.)
  - Token provider errors
  - Invalid JSON responses
  - Optional fields handling
  - Configuration options

### Integration Tests
- Located in `integration_test.go`
- Require `USPS_TOKEN` environment variable
- Skip automatically if token not provided
- Test against real USPS API

## Future Considerations
- Rate limiting handling (429 responses with retry-after)
- Circuit breaker pattern for resilience
- Metrics/observability hooks
- Batch request support if API supports it
- Caching layer for frequently requested data
- Request/response logging option

## Maintenance Guidelines

### Adding New Features
1. Update models if new fields are added to API
2. Add tests for new functionality
3. Update documentation and examples
4. Ensure backward compatibility
5. Update this file with changes

### Updating for API Changes
1. Review USPS API changelog
2. Update OpenAPI spec reference in issue
3. Update models to match new spec
4. Add/update tests
5. Update documentation

### Version Management
- Follow semantic versioning
- Tag releases in git
- Document breaking changes
- Provide migration guides for major versions
